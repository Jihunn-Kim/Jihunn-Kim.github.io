---
title: "컴퓨터 구조 요약 - 파이프라인"
last_modified_at: 2021-01-19
excerpt: ""
categories:
  - computer_architecture
---

## 1. 병렬 처리
병렬 처리는 컴퓨터의 처리 속도와 처리율을 증가시키기 위해 동시 데이터 처리 기능을 제공하는 기술이다. 
병렬 처리는 프로세서 내외부 구조와 정보 흐름 등을 고려하여 다양한 방법으로 분류된다. 
그 중 동시에 처리되는 명령어와 데이터 항목수에 따라 컴퓨터를 분류할 수 있다. 
1. 단일 명령어 흐름, 단일 데이터 흐름(SISD)
	- 단일 제어 장치, 처리 장치, 메모리 장치, 순차적 명령어 실행
	- 병렬 처리를 위해 다중 기능 장치, 파이프라인 처리 사용 
2. 단일 명령어 흐름, 다중 데이터 흐름(SIMD)
	- 공통 제어 장치, 다중 처리 장치
	- 처리 장치들의 동시 메모리 접근을 위해 다중 모듈을 가진 공유 메모리 장치 사용
3. 다중 명령어 흐름, 단일 데이터 흐름(MISD)
	- 이론적으로만 연구 되었음
4. 다중 명령어 흐름, 다중 데이터 흐름(MIMD)
	- 다중 처리 장치(프로세서), 다중 컴퓨팅 시스템

또한 다음과 같은 관점으로 병렬 처리를 살펴볼 수 있다.
1. 파이프라인 처리 - 산술 연산, 명령어 사이클 각 단계 중첩
2. 벡터 처리 - 크기가 큰 벡터나 행렬 처리
3. 배열 프로세서 - 큰 배열에 대한 계산

## 2. 파이프라인
파이프라인이란 하나의 프로세스를 서로 다른 기능을 가진 여러 개의 서브프로세스로 나누어, 
각 서브프로세스가 동시에 연산을 수행하는 기법이다. 
각 서브프로세스를 각각의 세그멘트로서 구현하고, 수행된 연산 결과를 각 세그먼트 사이에 둔 레지스터에 전달함으로써 병렬 처리를 수행한다. 
프로세스가 수행되는 시간과 서브프로세스로 나뉘어 수행되는 시간이 같다고 가정하면, 파이프라인에 의한 이론적 최대 속도 증가율은 세그멘트 수와 같다. 

---

파이프라인이 적용되는 영역은 산술 연산과 명령어 사이클이 있다. 
산술 연산 중 부동 소숫점 가산기를 아래와 같이 서브프로세스로 나눌 수 있다.
1. 지수의 비교
2. 가수의 정렬
3. 가수의 덧셈이나 뺄셈
4. 결과의 정규화

명령어 사이클은 다음과 같이 나눌 수 있다.
1. 메모리에서 명령어 읽기(fetch)
2. 명령어 종류 결정(decode)
3. 유효 주소 계산
4. 메모리에서 피연산자 읽기(fetch)
5. 명령어 실행

---

실제로 파이프라인은 이론적인 최대 속도로 수행되지는 못한다. 
각 세그먼트들이 수행되는 시간이 서로 다르고, 
클럭 사이클이 최대 지연 시간을 갖는 세그먼트와 동일하게 결정되어야 한다. 
따라서 다른 세그먼트들은 이를 기다려야 한다. 더욱이 명령어 파이프라인은 아래와 같은 문제가 발생할 수 있다. 
1. 자원 충돌 - 서로 다른 세그먼트가 동시에 메모리를 접근할 때 발생
2. 데이터 의존성 충돌 - 어떤 명령어가 이전 명령어의 결과를 기다릴 때 발생
3. 분기 곤란 - 분기 명령어같이 PC 값을 변경시킬 때 발생

자원 충돌은 명령어 메모리와 데이터 메모리를 분리함으로써 해결한다. 
데이터 의존성 충돌은 하드웨어 인터락(명령어의 피연산자가 앞선 명령어의 목적지라면, 피연산자가 준비될 때까지 해당 명령어는 지연됨), 
오퍼랜드 포워딩(하드웨어로 충돌을 감지하고 별도의 통로를 통해 데이터를 세그먼트로 보냄)을 활용한다. 
분기 곤란이 발생하면 프로그램의 실행 순서가 바뀌기 때문에, 파이프라인이 전부 비워져야 한다. 
이를 처리하기 위한 한 가지 방법은, 분기 후 사용될 명령어를 미리 가져와 분기가 수행될 때까지 저장하는 것이다. 
다른 방법으로 분기 목표 버퍼(BTB)가 있다. 이는 이전에 실행된 분기 명령어와 이에 해당하는 분기 목표 명령어를 저장하고 있다. 
분기 명령어가 디코드되면 이를 읽어와 진행한다. BTB의 변형으로 루프 버퍼(loop buffer)가 있고, 
이는 루프가 있는 경우에 분기를 포함한 모든 것을 저장한다. 분기 예측이라는 방법도 있고, 조건 분기 명령어에 사용되는 조건 명령어를 추측한 후 
예측된 경로의 명령어를 미리 읽는 방식이다.

---

RISC 컴퓨터는 파이프라인을 보다 효과적으로 이용할 수 있다. 
명령어 집합이 단순하기 때문에 한 클럭 사이클에 수행되는 소수의 서브프로세스로 파이프라인을 구성할 수 있다. 
또한 모든 피연산자가 레지스터에 있기 때문에 메모리로부터 피연산자를 읽어올 필요가 없다. 
마지막으로 하드웨어 대신에 컴파일러를 사용하여 데이터 의존성 충돌, 분기 곤란을 해결한다. 
먼저, 지연된 로드를 통해 데이터 의존성 충돌 해결한다. 컴파일러는 LOAD명령어 다음에 바로 해당 데이터를 사용하는 명령어가 따라오면 
무동작 명령어를 삽입하여 클럭 사이클을 낭비시킨다. 그리고 지연된 분기를 통해 분기 곤란을 해결한다. 
컴파일러는 분기 명령어 전후에 있는 명령어들을 분석하여, 프로그램 결과에 영향을 주지 않으면서 분기 명령어 앞의 몇 개의 명령어들을 
분기 명령어 다음으로 옮길 수 있다. 이것이 여의치 못한 경우에는 무동작 명령어를 삽입한다.

## 3. 벡터, 행렬 처리
벡터는 일차원 배열에 대한 순서화된 집합이며, 방대한 수가 담긴 벡터를 다루기 위해 벡터 프로세서가 빠른 연산을 제공한다. 
길이가 100인 벡터 A, B를 더하는 과정을 예를 들 수 있다. 벡터 명령어는 100번 루프를 돌며 명령어를 fecth, 실행할 필요 없이, 
한번의 명령어로 이를 수행할 수 있다. 이는 많은 수의 곱셈과 덧셈이 필요한 행렬 계산에서 특히 중요하다. 

---

파이프라인이나 벡터 프로세서에서는 두 개 이상의 메모리 접근이 동시에 발생해 자원 충돌이 일어날 수 있다. 
이를 해결하기 위해, 메모리를 여러 개의 모듈로 나누고 공통의 메모리 주소 버스와 데이터 버스로 연결하는 방법을 사용한다. 
모듈로 나뉜 각 메모리에는 어드레스 레지스터와 데이터 레지스터가 붙는다. 
이러한 모듈 메모리에는 인터리빙이란 기법이 적용되는데, 메모리에 있는 주소가 각 모듈에 대해 돌아가며 연속적으로 있게 하는 기법이다. 
```console
3개 모듈로 나뉘었을 때,
주소 1 -> 1번 모듈
주소 2 -> 2번 모듈
주소 3 -> 3번 모듈
주소 4 -> 1번 모듈
주소 5 -> 2번 모듈
주소 6 -> 3번 모듈
...
```

## 4. 배열 프로세서
배열 프로세서는 대규모의 데이터 배열에 대한 계산을 수행하는 프로세서이다. 
부가 배열 프로세서는 컴퓨터에 부착하여 수치 계산 작업에 대한 컴퓨터의 성능을 향상시킬 수 있다. 
SIMD 배열 프로세서는 벡터나 행렬 형식 수치 계산에만 적합하기에 더이상 사용되지 않는다. 


